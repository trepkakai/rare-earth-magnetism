%% New fitting model

% Data

% 4K
%TeslaResponse = [-2.63239E-05 0.026308607 0.053328336 0.080864388 0.108844801 0.137100832 0.137713884 0.142431353 0.142048344 0.113793917 0.086022648 0.057325826 0.02863143 -0.000460093 -0.000463905 -0.029123533 -0.058047305 -0.086961859 -0.115936109 -0.144769292 -0.144852474 -0.132576316 -0.132619407 -0.111385625 -0.083385813 -0.056543875 -0.028494061 0.000491808 -2.63513E-05 0.026351279 0.053354356 0.080823004 0.10894345 0.136877668 0.137808809 0.205782073 0.273755336 0.34079746 0.400390458 0.461845738 0.519576455 0.519576455 0.627588764 0.704873434 0.797987494 0.888308132 0.968386224 1.02425466 1.108057314 1.173237156 1.238416998 1.284974028 1.284974028 1.238416998 1.173237156 1.108057314 1.042877472 0.968386224 0.882721289 0.796125213 0.703011153 0.525163298 0.525163298 0.467432581 0.407839583 0.344522022 0.27934218 0.211368916 0.142464512 0.142464512 0.113599153 0.086037391 0.057358261 0.028586016 -0.000459983 -0.000463708 -0.029144701 -0.058010059 -0.086968532 -0.116392575 -0.144326793 -0.145257934 -0.216024619 -0.282135602 -0.348246584 -0.412495286 -0.471157144 -0.528887861 -0.528887861 -0.625726483 -0.723496246 -0.817541447 -0.851993649 -0.9311406 -1.005631848 -1.080123096 -1.135991532 -1.201171374 -1.247728404 -1.247728404 -1.191859968 -1.145302938 -1.089434502 -1.014943254 -0.9311406 -0.860373914 -0.77564012 -0.689044044 -0.594067703 -0.486055393 -0.486055393 -0.432049238 -0.377111943 -0.319381226 -0.258857087 -0.196470667 -0.132221965 -0.132221965 -0.111736872 -0.083430198 -0.056520234 -0.028492902 0.000491642];
%HoverT = [0 0.025 0.05 0.075 0.1 0.125 0.125 0.125 0.125 0.1 0.075 0.05 0.025 0 0 -0.025 -0.05 -0.075 -0.1 -0.125 -0.125 -0.125 -0.125 -0.1 -0.075 -0.05 -0.025 0 0 0.025 0.05 0.075 0.1 0.125 0.125 0.1875 0.25 0.3125 0.375 0.4375 0.5 0.5 0.625 0.75 0.875 1 1.125 1.25 1.375 1.5 1.625 1.75 1.75 1.625 1.5 1.375 1.25 1.125 1 0.875 0.75 0.5 0.5 0.4375 0.375 0.3125 0.25 0.1875 0.125 0.125 0.1 0.075 0.05 0.025 0 0 -0.025 -0.05 -0.075 -0.1 -0.125 -0.125 -0.1875 -0.25 -0.3125 -0.375 -0.4375 -0.5 -0.5 -0.625 -0.75 -0.875 -1 -1.125 -1.25 -1.375 -1.5 -1.625 -1.75 -1.75 -1.625 -1.5 -1.375 -1.25 -1.125 -1 -0.875 -0.75 -0.625 -0.5 -0.5 -0.4375 -0.375 -0.3125 -0.25 -0.1875 -0.125 -0.125 -0.1 -0.075 -0.05 -0.025 0];

% >= 7 K
TeslaResponse = [-2.11689E-05 0.013496557 0.026887223 0.040340684 0.053854017 0.067056142 0.067072178 0.053548499 0.040065061 0.026716152 0.01335311 -0.000108603 -0.013591347 -0.027007578 -0.040511667 -0.054048573 -0.067164051 -0.067246302 -0.05373002 -0.040254238 -0.026792686 -0.013450523 -2.35025E-05 -3.12357E-05 0.004458788 0.008870232 0.013251998 0.017653515 0.022062207 0.022016442 0.013263518 0.008896686 0.004439838 -2.29454E-05 -0.004502114 -0.008933689 -0.013311938 -0.017699462 -0.022082299 -0.022057376 -0.017697884 -0.012758732 -0.008896842 -0.004475612 -3.59503E-05 1.73906E-06 0.001020882 0.002017886 0.003038035 0.004034506 0.00504231 0.00505529 0.005111607 0.005072538 0.004056164 0.003055026 0.002157716 0.001193883 -1.45332E-05 -2.91128E-05 -0.001013765 -0.00201914 -0.003033093 -0.004050347 -0.005050935 -0.005056372 -0.005112625 -0.005074342 -0.004059924 -0.003058799 -0.002030406 -0.001011613 8.23177E-06 1.74123E-06 0.001024255 0.002020575 0.003035518 0.004031839 0.005046782 0.005056093 0.007579484 0.010056318 0.012663512 0.015177592 0.017691671 0.020205751 0.020205751 0.02523391 0.030355184 0.035290229 0.040411502 0.045532775 0.050560935 0.055589094 0.060617253 0.06583164 0.070114887 0.070114887 0.065272956 0.060244797 0.055216638 0.050188478 0.045253433 0.040225274 0.035197115 0.030168955 0.025140796 0.020112637 0.020205751 0.017691671 0.015177592 0.012663512 0.010149433 0.007626042 0.005111962 0.005074716 0.004059773 0.003054141 0.002160246 0.00119186 -1.45258E-05 -2.91447E-05 -0.001014943 -0.002020575 -0.003035518 -0.004050462 -0.005046782 -0.005056093 -0.007588796 -0.010149433 -0.012663512 -0.015177592 -0.017691671 -0.020205751 -0.020205751 -0.025327024 -0.030355184 -0.035383343 -0.040504616 -0.045625889 -0.050654049 -0.055682208 -0.060803481 -0.06583164 -0.070394229 -0.070301115 -0.065459184 -0.060337911 -0.055309752 -0.050188478 -0.045253433 -0.040225274 -0.035290229 -0.03026207 -0.02523391 -0.020205751 -0.020298865 -0.017784785 -0.015270706 -0.012663512 -0.010149433 -0.007579484 -0.005111962 -0.005074716 -0.004059773 -0.003063453 -0.002029887 -0.001014943 8.23128E-06 0.940452006 0.788676088 0.675076935 0.595929984 0.523301017 0.473019425 0.426462395 0.391079052 0.360351412 0.329623772 0.305414117 0.285860164 0.269099633 0.253270243 0.240234275 0.228129447 0.21695576 0.206713213 0.197401807 0.189021542 0.180641276 0.173192152 0.166674167 0.159225043 0.15456934 0.148982496 0.144326793 0.138739949 0.134084246 0.130359684 0.126635122 0.122910559 0.119185997 0.115461434 0.112668013 0.109874591 0.106150028 0.104287747 0.101494325 0.098700904 0.095907482 0.094045201 0.092182919 0.089855068 0.087806559 0.086037391 0.084081996 0.082219715 0.080543662 0.079053837 0.077564012 0.076074187 0.074677476 0.073373879 0.072070282 0.070766686 0.069556203 0.068438834 1.154614344];
HoverT = [0 0.00625 0.0125 0.01875 0.025 0.03125 0.03125 0.025 0.01875 0.0125 0.00625 0 -0.00625 -0.0125 -0.01875 -0.025 -0.03125 -0.03125 -0.025 -0.01875 -0.0125 -0.00625 0 0 0.0015625 0.003125 0.0046875 0.00625 0.0078125 0.0078125 0.0046875 0.003125 0.0015625 0 -0.0015625 -0.003125 -0.0046875 -0.00625 -0.0078125 -0.0078125 -0.00625 -0.0046875 -0.003125 -0.0015625 0 0 0.000338983 0.000677966 0.001016949 0.001355932 0.001694915 0.001694915 0.001694915 0.001694915 0.001355932 0.001016949 0.000677966 0.000338983 0 0 -0.000338983 -0.000677966 -0.001016949 -0.001355932 -0.001694915 -0.001694915 -0.001694915 -0.001694915 -0.001355932 -0.001016949 -0.000677966 -0.000338983 0 0 0.000338983 0.000677966 0.001016949 0.001355932 0.001694915 0.001694915 0.002542373 0.003389831 0.004237288 0.005084746 0.005932203 0.006779661 0.006779661 0.008474576 0.010169492 0.011864407 0.013559322 0.015254237 0.016949153 0.018644068 0.020338983 0.022033898 0.023728814 0.023728814 0.022033898 0.020338983 0.018644068 0.016949153 0.015254237 0.013559322 0.011864407 0.010169492 0.008474576 0.006779661 0.006779661 0.005932203 0.005084746 0.004237288 0.003389831 0.002542373 0.001694915 0.001694915 0.001355932 0.001016949 0.000677966 0.000338983 0 0 -0.000338983 -0.000677966 -0.001016949 -0.001355932 -0.001694915 -0.001694915 -0.002542373 -0.003389831 -0.004237288 -0.005084746 -0.005932203 -0.006779661 -0.006779661 -0.008474576 -0.010169492 -0.011864407 -0.013559322 -0.015254237 -0.016949153 -0.018644068 -0.020338983 -0.022033898 -0.023728814 -0.023728814 -0.022033898 -0.020338983 -0.018644068 -0.016949153 -0.015254237 -0.013559322 -0.011864407 -0.010169492 -0.008474576 -0.006779661 -0.006779661 -0.005932203 -0.005084746 -0.004237288 -0.003389831 -0.002542373 -0.001694915 -0.001694915 -0.001355932 -0.001016949 -0.000677966 -0.000338983 0 0.583333333 0.411764706 0.318181818 0.259259259 0.21875 0.189189189 0.166666667 0.14893617 0.134615385 0.122807018 0.112903226 0.104477612 0.097222222 0.090909091 0.085365854 0.080367394 0.076004343 0.072090628 0.068627451 0.065420561 0.0625 0.05982906 0.057377049 0.05511811 0.053030303 0.051094891 0.049295775 0.047619048 0.046052632 0.044585987 0.043209877 0.041916168 0.040697674 0.039548023 0.038461538 0.037433155 0.036458333 0.035532995 0.034653465 0.033816425 0.033018868 0.032258065 0.031531532 0.030837004 0.030172414 0.029535865 0.02892562 0.028340081 0.027777778 0.027237354 0.026717557 0.026217228 0.025735294 0.025270758 0.024822695 0.024390244 0.023972603 0.023569024 1];


% muB/kB = 0.672 (so that parameter in Langevin is dimensionless)
% alpha = 0.01165 (so that N is in units of 1/nm^3

% Define a fit model with a the fraction of surface atoms and (1-a) the
% fraction of interior atoms, and b the moment of surface atoms. 

fo = fitoptions('Method','NonlinearLeastSquares',...
               'Lower',[0,0],...
               'Upper',[1,7.94],...
               'StartPoint',[0,1]);
fo2 = fitoptions('Method','NonlinearLeastSquares',...
               'Lower',[0,0,0],...
               'Upper',[1,7.94,3],...
               'StartPoint',[0.5,5,0.5]);
% Use for high T
%ft = fittype('24.6*0.01165*a*b*(coth(b*c*x)-1./(b*c*x)) + 24.6*0.01165*(1-a)*7.94*(coth(7.94*c*x)-1./(7.94*c*x))','options',fo2);
%Use for low T
ft = fittype('24.6*0.01165*a*b*(coth(b*.68*x)-1./(b*.68*x)) +  24.6*0.01165*(1-a)*7.94*(coth(7.94*.68*x)-1./(7.94*.68*x))','options',fo);


% Parameters
moment = 7.94;
N = 24.6;

% Perform nonlinear fitting
HoverT = HoverT + 0.0000000000001;
TeslaResponse = TeslaResponse + 0.00000000001;
[fitobject,gof,output]=fit(HoverT.',TeslaResponse.',ft)

% For extraction
coeff = coeffvalues(fitobject);
CI = confint(fitobject);

% Fraction that are surface
s = coeff(1);
s_err = (CI(2)-CI(1))/2; % To get this, fixed mu at the fitted value and ran to get s;
%s_err = 0.02

% mu internal (bohr magnetons)
mu = coeff(2);
mu_err = (CI(4)-CI(3))/2;

% Ms (T)
Ms = N*0.01165*(mu*s+moment*(1-s));
Ms_err = ( N*0.01165*((mu+mu_err)*s+moment*(1-s)) - N*0.01165*((mu-mu_err)*s+moment*(1-s)) )/2;


