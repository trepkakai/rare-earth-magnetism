%% New fitting model

% Data. Comment out the temp regime to fit for

% 4K
%TeslaResponse = [0.280437807 0.277217397 0.229353919 0.172862608 0.116531204 0.058433858 -0.000832605 -0.000847551 -0.058448435 -0.11584526 -0.17138581 -0.227099222 -0.282282446 -0.283053199 -0.284262523 -0.27921084 -0.226600238 -0.174067709 -0.118170421 -0.058690674 0.00090566 0.000921407 0.058964902 0.116575649 0.171987354 0.227272263 0.282546017 0.283648416 1.35260424 1.35260424 1.3231998 1.30359684 1.28399388 1.25458944 1.225185 1.15657464 1.09776576 0.98994948 0.879192756 0.86253024 0.77431692 0.70080582 0.604751316 0.513597552 0.404801124 0.280322328 0.277381884 0.229354632 0.172506048 0.116637612 0.058416821 -0.000832146 -0.000847828 -0.058416821 -0.115657464 -0.1715259 -0.227394336 -0.282282624 -0.283262772 -0.398920236 -0.505756368 -0.6125925 -0.677282268 -0.771376476 -0.819403728 -0.825284616 -0.951723708 -1.05855984 -1.13697168 -1.1761776 -1.23498648 -1.26439092 -1.30359684 -1.3231998 -1.35260424 -1.3722072 -1.3722072 -1.36240572 -1.33300128 -1.30359684 -1.28399388 -1.25458944 -1.20558204 -1.16637612 -1.08796428 -0.99975096 -0.87233172 -0.865470684 -0.780197808 -0.704726412 -0.608671908 -0.516537996 -0.403820976 -0.28424292 -0.27934218 -0.226414188 -0.174466344 -0.118597908 -0.058710865 0.000905657 0.000921339 0.05900491 0.116637612 0.1715259 0.227394336 0.282282624 0.283262772 0.397940088 0.510657108 0.608671908 0.682183008 0.77431692 0.816463284 0.835086096 0.943882524 1.05855984 1.1271702 1.19578056 1.23498648 1.2741924 1.29379536 1.3231998 1.34280276 1.3722072];
%HoverT = [0.125 0.125 0.1 0.075 0.05 0.025 0 0 -0.025 -0.05 -0.075 -0.1 -0.125 -0.125 -0.125 -0.125 -0.1 -0.075 -0.05 -0.025 0 0 0.025 0.05 0.075 0.1 0.125 0.125 1.75 1.625 1.5 1.375 1.25 1.125 1 0.875 0.75 0.625 0.5 0.5 0.4375 0.375 0.3125 0.25 0.1875 0.125 0.125 0.1 0.075 0.05 0.025 0 0 -0.025 -0.05 -0.075 -0.1 -0.125 -0.125 -0.1875 -0.25 -0.3125 -0.375 -0.4375 -0.5 -0.5 -0.625 -0.75 -0.875 -1 -1.125 -1.25 -1.375 -1.5 -1.625 -1.75 -1.75 -1.625 -1.5 -1.375 -1.25 -1.125 -1 -0.875 -0.75 -0.625 -0.5 -0.5 -0.4375 -0.375 -0.3125 -0.25 -0.1875 -0.125 -0.125 -0.1 -0.075 -0.05 -0.025 0 0 0.025 0.05 0.075 0.1 0.125 0.125 0.1875 0.25 0.3125 0.375 0.4375 0.5 0.5 0.625 0.75 0.875 1 1.125 1.25 1.375 1.5 1.625 1.75];

% >= 16 K
TeslaResponse = [3.94756E-05 0.027073505 0.054052739 0.081037158 0.108128876 0.13537699 0.135410404 0.108348001 0.081136865 0.053937651 0.02688464 -0.00027809 -0.027430885 -0.054440467 -0.081582458 -0.108714434 -0.135840547 -0.135891996 -0.1088086 -0.081578573 -0.0544474 -0.027186401 9.35265E-05 2.21897E-05 0.009456819 0.018836752 0.028063633 0.037490412 0.046867915 0.04682085 0.037445396 0.028066395 0.018682245 0.009363643 -0.00010516 -0.018858974 -0.028228138 -0.037564172 -0.046950212 -0.046907264 -0.037525501 -0.028178221 -0.018771082 -0.009450065 2.1999E-05 0.011815009 0.011810548 0.009423882 0.00711261 0.004746406 0.002588018 -2.74678E-05 -3.20287E-05 -0.002414855 -0.004788142 -0.007167225 -0.009551496 -0.011932151 -0.011933468 -0.011857793 -0.011849768 -0.009480391 -0.007133569 -0.004751332 -0.00235963 3.58215E-05 3.58559E-05 0.00242767 0.004802173 0.007186151 0.162704568 0.15192294 0.140161164 0.128399388 0.116637612 0.104875836 0.093506119 0.081744343 0.070374626 0.05880888 0.047145119 0.047145119 0.041264231 0.035383343 0.029502455 0.023621567 0.017740679 0.011859791 0.011761776 0.009419222 0.007115874 0.004743916 0.002587591 -2.74441E-05 -3.20508E-05 -0.002411164 -0.004792924 -0.007164882 -0.009546642 -0.011957806 -0.011957806 -0.017936708 -0.023719582 -0.029698484 -0.035677387 -0.041558275 -0.047439163 -0.047439163 -0.059298954 -0.07125676 -0.08311655 -0.094878326 -0.106836132 -0.11761776 -0.129379536 -0.141141312 -0.15192294 -0.163684716 -0.162704568 -0.15192294 -0.140161164 -0.129379536 -0.11761776 -0.105855984 -0.094682297 -0.082920521 -0.059396969 -0.047537178 -0.047439163 -0.041558275 -0.035677387 -0.029698484 -0.023719582 -0.017838694 -0.011859791 -0.011859791 -0.009478031 -0.007135477 -0.004753718 -0.002362157 3.57754E-05 3.58734E-05 0.002430767 0.004802725 0.007184485 1.1761776 1.10756724 1.01935392 0.917418528 0.8576295 0.805681656 0.735111 0.691984488 0.658659456 0.619453536 0.577307172 0.550843176 0.521438736 0.495954888 0.47537178 0.448907784 0.427344528 0.413622456 0.395979792 0.381277572 0.369515796 0.354813576 0.344031948 0.33325032 0.321488544 0.311687064 0.30384588 0.296004696 0.287183364 0.278362032 0.271500996 0.26463996 0.257778924 0.251898036 0.246017148 0.24013626 0.234255372 0.228374484 0.223473744 0.218573004 0.213672264 0.21073182 0.20583108 0.201910488 0.197989896 0.193089156 0.190148712 0.18622812 0.183287676 0.180347232 0.177406788 0.174466344 0.1715259 0.169565604 0.16662516 0.163684716 0.160744272];
HoverT = [0 0.00625 0.0125 0.01875 0.025 0.03125 0.03125 0.025 0.01875 0.0125 0.00625 0 -0.00625 -0.0125 -0.01875 -0.025 -0.03125 -0.03125 -0.025 -0.01875 -0.0125 -0.00625 0 0 0.0015625 0.003125 0.0046875 0.00625 0.0078125 0.0078125 0.00625 0.0046875 0.003125 0.0015625 0 -0.003125 -0.0046875 -0.00625 -0.0078125 -0.0078125 -0.00625 -0.0046875 -0.003125 -0.0015625 0 0.001694915 0.001694915 0.001355932 0.001016949 0.000677966 0.000338983 0 0 -0.000338983 -0.000677966 -0.001016949 -0.001355932 -0.001694915 -0.001694915 -0.001694915 -0.001694915 -0.001355932 -0.001016949 -0.000677966 -0.000338983 0 0 0.000338983 0.000677966 0.001016949 0.023728814 0.022033898 0.020338983 0.018644068 0.016949153 0.015254237 0.013559322 0.011864407 0.010169492 0.008474576 0.006779661 0.006779661 0.005932203 0.005084746 0.004237288 0.003389831 0.002542373 0.001694915 0.001694915 0.001355932 0.001016949 0.000677966 0.000338983 0 0 -0.000338983 -0.000677966 -0.001016949 -0.001355932 -0.001694915 -0.001694915 -0.002542373 -0.003389831 -0.004237288 -0.005084746 -0.005932203 -0.006779661 -0.006779661 -0.008474576 -0.010169492 -0.011864407 -0.013559322 -0.015254237 -0.016949153 -0.018644068 -0.020338983 -0.022033898 -0.023728814 -0.023728814 -0.022033898 -0.020338983 -0.018644068 -0.016949153 -0.015254237 -0.013559322 -0.011864407 -0.008474576 -0.006779661 -0.006779661 -0.005932203 -0.005084746 -0.004237288 -0.003389831 -0.002542373 -0.001694915 -0.001694915 -0.001355932 -0.001016949 -0.000677966 -0.000338983 0 0 0.000338983 0.000677966 0.001016949 0.411764706 0.318181818 0.259259259 0.21875 0.189189189 0.166666667 0.14893617 0.134615385 0.122807018 0.112903226 0.104477612 0.097222222 0.090909091 0.085365854 0.08045977 0.076086957 0.072164948 0.068627451 0.065420561 0.0625 0.05982906 0.057377049 0.05511811 0.053030303 0.051094891 0.049295775 0.047619048 0.046052632 0.044585987 0.043209877 0.041916168 0.040697674 0.039548023 0.038461538 0.037433155 0.036458333 0.035532995 0.034653465 0.033816425 0.033018868 0.032258065 0.031531532 0.030837004 0.030172414 0.029535865 0.02892562 0.028340081 0.027777778 0.027237354 0.026717557 0.026217228 0.025735294 0.025270758 0.024822695 0.024390244 0.023972603 0.023569024]

% muB/kB = 0.672 (so that parameter in Langevin is dimensionless)
% alpha = 0.01165 (so that N is in units of 1/nm^3

% Define a fit model with a the fraction of surface atoms and (1-a) the
% fraction of interior atoms, and b the moment of surface atoms

% For each new element, need to modify the moment (9 here) and overall N
% (24 here)
fo = fitoptions('Method','NonlinearLeastSquares',...
               'Lower',[0,0],...
               'Upper',[1,10.65],...
               'StartPoint',[0.1,10]);
% Use for high T
ft = fittype('25.2*0.01165*a*b*(coth(b*1.101*x)-1./(b*1.101*x)) + 25.2*0.01165*10.65*(1-a)*(coth(10.65*1.101*x)-1./(10.65*1.101*x))','options',fo);
% Use for low T
%ft = fittype('25.2*0.01165*a*b*(coth(b*.672*x)-1./(b*.672*x)) + 25.2*0.01165*10.65*(1-a)*(coth(10.65*.672*x)-1./(10.65*.672*x))','options',fo);

% Parameters
moment = 10.65;
N = 25.2;

% Perform nonlinear fitting
HoverT = HoverT + 0.0000000000001;
TeslaResponse = TeslaResponse + 0.00000000001;
[fitobject,gof,output]=fit(HoverT.',TeslaResponse.',ft)

% For extraction
coeff = coeffvalues(fitobject);
CI = confint(fitobject);

% Fraction that are surface
s = coeff(1);
s_err = (CI(2)-CI(1))/2;

% mu internal (bohr magnetons)
mu = coeff(2);
mu_err = (CI(4)-CI(3))/2;

% Ms (T)
Ms = N*0.01165*(mu*s+moment*(1-s));
Ms_err = ( N*0.01165*((mu+mu_err)*s+moment*(1-s)) - N*0.01165*((mu-mu_err)*s+moment*(1-s)) )/2;



