%% New fitting model

% Data

% 4K
%TeslaResponse = [0.000879493 0.05857861 0.113732514 0.165975859 0.213840266 0.265034531 0.261704673 0.257280096 0.25721068 0.206974526 0.155882409 0.108331435 -0.000884988 -0.000884548 -0.056705915 -0.111627956 -0.163701813 -0.216666303 -0.261592397 -0.261659219 0.000879419 0.05862793 0.113998752 0.166112467 0.213883373 0.264911386 0.261654278 0.382167245 0.497251699 0.602564832 0.703535155 0.794734157 0.878333242 0.880504646 1.022731661 1.13998752 1.226843712 1.30284288 1.335413952 1.357128 1.367985024 1.400556096 1.400556096 1.41141312 1.400556096 1.422270144 1.378842048 1.400556096 1.357128 1.335413952 1.30284288 1.226843712 1.13998752 1.021645958 0.875076134 0.873990432 0.790391347 0.700278048 0.600393427 0.49290889 0.377824435 0.257311469 0.257311469 0.207369158 0.156341146 0.1083531 -0.000884847 -0.000884847 -0.056673665 -0.111827347 -0.163941062 -0.21714048 -0.261654278 -0.261654278 -0.383252947 -0.499423104 -0.605821939 -0.70570656 -0.796905562 -0.880504646 -0.880504646 -1.024903066 -1.13998752 -1.215986688 -1.281128832 -1.335413952 -1.346270976 -1.378842048 -1.400556096 -1.41141312 -1.422270144 -1.400556096 -1.400556096 -1.400556096 -1.357128 -1.357128 -1.335413952];
%HoverT = [0 0.025 0.05 0.075 0.1 0.125 0.125 0.125 0.125 0.1 0.075 0.05 0 0 -0.025 -0.05 -0.075 -0.1 -0.125 -0.125 0 0.025 0.05 0.075 0.1 0.125 0.125 0.1875 0.25 0.3125 0.375 0.4375 0.5 0.5 0.625 0.75 0.875 1 1.125 1.25 1.375 1.5 1.625 1.75 1.75 1.625 1.5 1.375 1.25 1.125 1 0.875 0.75 0.625 0.5 0.5 0.4375 0.375 0.3125 0.25 0.1875 0.125 0.125 0.1 0.075 0.05 0 0 -0.025 -0.05 -0.075 -0.1 -0.125 -0.125 -0.1875 -0.25 -0.3125 -0.375 -0.4375 -0.5 -0.5 -0.625 -0.75 -0.875 -1 -1.125 -1.25 -1.375 -1.5 -1.625 -1.75 -1.75 -1.625 -1.5 -1.375 -1.25 -1.125];

% >= 12 K
TeslaResponse = [6.86823E-05 0.024365743 0.048639427 0.073126399 0.097675619 0.121862253 0.121886742 0.097400051 0.048736578 -0.000270202 -0.048928948 -0.122508005 -0.122493006 -0.097855403 -0.073357131 3.53258E-05 -1.08508E-05 0.026001648 0.034753306 0.043511092 0.043438109 0.034756241 -6.39435E-05 -0.008806562 -0.017471839 -0.026134208 -0.034845948 -0.02607936 -0.017411759 -0.008736189 -1.1348E-05 6.88557E-06 0.002133705 0.004244308 0.006378711 0.008484813 0.010598679 0.010602547 0.010601253 0.010588208 0.008480429 0.006515159 0.004244819 0.002140153 -2.39965E-05 -2.71016E-05 -0.002158231 -0.004260087 -0.006389278 -0.008493233 -0.010612367 -0.010622456 -0.010627675 -0.01059927 -0.008473622 -0.006367291 -0.004235293 -0.002145775 3.36119E-05 6.88335E-06 0.002138834 0.004245096 0.00638393 0.008490193 0.010596455 0.010607312 0.015851255 0.021171197 0.026382568 0.03170251 0.037022452 0.042342394 0.042342394 0.052765137 0.06351359 0.074153474 0.085227638 0.095433241 0.105313133 0.116170157 0.125941478 0.1357128 0.145484122 0.145484122 0.1357128 0.125941478 0.116170157 0.105313133 0.0952161 0.084684787 0.073827763 0.06318788 0.052765137 0.042233823 0.042125253 0.036913882 0.03159394 0.026382568 0.021062627 0.015851255 0.010596455 0.010585598 0.008479336 0.006514214 0.004245096 0.002138834 -2.3994E-05 -2.71426E-05 -0.002160548 -0.004255953 -0.00638393 -0.008490193 -0.010607312 -0.010618169 -0.015851255 -0.021171197 -0.026491139 -0.03159394 -0.036588171 -0.042125253 -0.042125253 -0.052765137 -0.063622161 -0.074479185 -0.085010498 -0.095650381 -0.105855984 -0.116170157 -0.127027181 -0.1357128 -0.145484122 -0.145484122 -0.1357128 -0.125941478 -0.116170157 -0.106507405 -0.095324671 -0.084576217 -0.073827763 -0.06329645 -0.052873707 -0.042233823 -0.042233823 -0.036913882 -0.03170251 -0.026382568 -0.021171197 -0.015959825 -0.010629026 -0.010596455 -0.008468479 -0.006362216 -0.004234239 -0.002149691 3.36568E-05 1.30284288 1.183415616 1.071588269 0.970617946 0.896790182 0.826219526 0.761077382 0.706792262 0.653592845 0.610164749 0.56565095 0.533079878 0.501594509 0.475537651 0.453823603 0.431023853 0.410395507 0.390852864 0.372395923 0.35719609 0.343081958 0.328967827 0.315939398 0.305082374 0.295311053 0.283368326 0.273597005 0.265997088 0.258397171 0.250797254 0.24428304 0.238854528 0.232340314 0.230168909 0.223654694 0.218226182 0.211711968 0.208454861 0.203026349 0.198683539 0.19434073 0.18999792 0.18565511 0.182398003 0.180226598 0.175883789 0.172626682 0.169369574 0.16719817 0.16285536 0.159598253 0.157426848 0.154169741 0.150912634 0.148741229 0.146569824 0.144398419 0.141141312];
HoverT = [0 0.00625 0.0125 0.01875 0.025 0.03125 0.03125 0.025 0.0125 0 -0.0125 -0.03125 -0.03125 -0.025 -0.01875 0 0 0.0046875 0.00625 0.0078125 0.0078125 0.00625 0 -0.0015625 -0.003125 -0.0046875 -0.00625 -0.0046875 -0.003125 -0.0015625 0 0 0.000338983 0.000677966 0.001016949 0.001355932 0.001694915 0.001694915 0.001694915 0.001694915 0.001355932 0.001016949 0.000677966 0.000338983 0 0 -0.000338983 -0.000677966 -0.001016949 -0.001355932 -0.001694915 -0.001694915 -0.001694915 -0.001694915 -0.001355932 -0.001016949 -0.000677966 -0.000338983 0 0 0.000338983 0.000677966 0.001016949 0.001355932 0.001694915 0.001694915 0.002542373 0.003389831 0.004237288 0.005084746 0.005932203 0.006779661 0.006779661 0.008474576 0.010169492 0.011864407 0.013559322 0.015254237 0.016949153 0.018644068 0.020338983 0.022033898 0.023728814 0.023728814 0.022033898 0.020338983 0.018644068 0.016949153 0.015254237 0.013559322 0.011864407 0.010169492 0.008474576 0.006779661 0.006779661 0.005932203 0.005084746 0.004237288 0.003389831 0.002542373 0.001694915 0.001694915 0.001355932 0.001016949 0.000677966 0.000338983 0 0 -0.000338983 -0.000677966 -0.001016949 -0.001355932 -0.001694915 -0.001694915 -0.002542373 -0.003389831 -0.004237288 -0.005084746 -0.005932203 -0.006779661 -0.006779661 -0.008474576 -0.010169492 -0.011864407 -0.013559322 -0.015254237 -0.016949153 -0.018644068 -0.020338983 -0.022033898 -0.023728814 -0.023728814 -0.022033898 -0.020338983 -0.018644068 -0.016949153 -0.015254237 -0.013559322 -0.011864407 -0.010169492 -0.008474576 -0.006779661 -0.006779661 -0.005932203 -0.005084746 -0.004237288 -0.003389831 -0.002542373 -0.001694915 -0.001694915 -0.001355932 -0.001016949 -0.000677966 -0.000338983 0 0.583333333 0.411764706 0.318181818 0.259259259 0.21875 0.189189189 0.166666667 0.14893617 0.134615385 0.122807018 0.112903226 0.104477612 0.097222222 0.090909091 0.085365854 0.08045977 0.076004343 0.072090628 0.068627451 0.065420561 0.0625 0.05982906 0.057377049 0.05511811 0.053030303 0.051094891 0.049295775 0.047619048 0.046052632 0.044585987 0.043209877 0.041916168 0.040697674 0.039548023 0.038461538 0.037433155 0.036458333 0.035532995 0.034653465 0.033816425 0.033018868 0.032258065 0.031531532 0.030837004 0.030172414 0.029535865 0.02892562 0.028340081 0.027777778 0.027237354 0.026717557 0.026217228 0.025735294 0.025270758 0.024822695 0.024390244 0.023972603 0.023569024];


% muB/kB = 0.672 (so that parameter in Langevin is dimensionless)
% alpha = 0.01165 (so that N is in units of 1/nm^3

% Define a fit model with a the fraction of surface atoms and (1-a) the
% fraction of interior atoms, and b the moment of surface atoms

% For each new element, need to modify the moment (9 here) and overall N
% (24 here)
fo = fitoptions('Method','NonlinearLeastSquares',...
               'Lower',[0,0],...
               'Upper',[1,9.58],...
               'StartPoint',[0.1,0.1]);
ft = fittype('27.2*0.01165*a*b*(coth(b*.672*(x))-1./(b*.672*(x))) + 27.2*0.01165*(1-a)*9.58*(coth(9.58*.672*(x))-1./(9.58*.672*(x)))','options',fo);

% Parameters
moment = 9.58;
N = 27.2;

% Perform nonlinear fitting
HoverT = HoverT + 0.0000000000001;
TeslaResponse = TeslaResponse + 0.00000000001;
[fitobject,gof,output]=fit(HoverT.',TeslaResponse.',ft)

% For extraction
coeff = coeffvalues(fitobject);
CI = confint(fitobject);

% Fraction that are surface
s = coeff(1);
s_err = (CI(2)-CI(1))/2;

% mu internal (bohr magnetons)
mu = coeff(2);
mu_err = (CI(4)-CI(3))/2;

% Ms (T)
Ms = N*0.01165*(mu*s+moment*(1-s));
Ms_err = ( N*0.01165*((mu+mu_err)*s+moment*(1-s)) - N*0.01165*((mu-mu_err)*s+moment*(1-s)) )/2;
% For low temp
Ms2 = N*0.01165*mu;
Ms2_err = N*0.01165*mu_err;


